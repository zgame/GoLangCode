---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2018/11/6 16:54
---

--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
--- 这是每个玩家的连接接收到网络消息之后的处理， 当涉及到多人游戏的时候， 需要通过MultiThreadChannelGameManagerToPlayer 来和游戏桌子逻辑进行数据交互，因为多线程需要保证线程安全
---
--- 如果自己单人游戏就不用了， 直接把处理游戏的逻辑写在这里就好了。
--------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------



--local CMD_Game_pb = require("CMD_Game_pb")


----客户端开火
function HandleUserFire(userId, buf)
    local msg = CMD_Game_pb.CMD_C_USER_FIRE()
    msg:ParseFromString(buf)


    local player,game, gameTable = GetPlayer_Game_Table(userId)
    if player ==nil or game ==nil or gameTable ==nil then
        --Logger("玩家数据："..player.."game:"..game.."table:"..table)
        return
    end
    gameTable:HandleUserFire(player , msg.lock_fish_id )       -- 桌子会发送消息给玩家



    --local data = {}
    --data.Player = MyPlayer
    --data.LockFishId =  msg.lock_fish_id     -- 要打击的鱼id
    --local result = MultiThreadChannelGameManagerToPlayer("HandleUserFire",data)
    --if result.error ~= nil then
    --    LuaNetWorkSendToUser(userId, MDM_GR_LOGON, SUB_GR_LOGON_FAILURE, nil, "没找到正确的桌子")
    --    return
    --end

    --print("开火完成")

end

--- 客户端抓鱼
function HandleCatchFish(userId, buf)
    local msg = CMD_Game_pb.CMD_C_CATCH_FISH()
    msg:ParseFromString(buf)

    if msg.fish_uid == 0 then
        return   -- 鱼的uid不为0
    end


    local player,game, gameTable = GetPlayer_Game_Table(userId)
    if player ==nil or game ==nil or gameTable ==nil then
        --Logger("玩家数据："..player.."game:"..game.."table:"..table)
        return
    end

    local LockFishIdList = {}      -- 要打击的鱼id
    table.insert(LockFishIdList, msg.fish_uid)-- 要打击的鱼id
    gameTable:LogicCatchFish(player,LockFishIdList, msg.bullet_id)


    --local data = {}
    --data.Player = MyPlayer
    --data.LockFishIdList = {}      -- 要打击的鱼id
    --data.LockFishIdList[1] =  msg.fish_uid     -- 要打击的鱼id
    --data.BulletId =  msg.bullet_id
    --local result = MultiThreadChannelGameManagerToPlayer("HandleCatchFish",data)
    --if result.error ~= nil then
    --    LuaNetWorkSendToUser(userId,MDM_GR_LOGON, SUB_GR_LOGON_FAILURE, nil, "没找到正确的桌子")
    --    return
    --end
--    print("抓鱼完成")
end


--- 通用函数，获取玩家的数据
function GetPlayer_Game_Table(userId)
    local player = GetPlayerByUID(userId)
    if player == nil then
        LuaNetWorkSendToUser(userId,MDM_GR_LOGON, SUB_GR_LOGON_FAILURE, nil, "玩家没有正常登录", nil)
        return nil,nil,nil
    end

    local game = GetGameByID(player.GameType)
    if game == nil then
        LuaNetWorkSendToUser(userId,MDM_GR_LOGON, SUB_GR_LOGON_FAILURE, nil, "请求登录游戏类型不正确", nil)
        return nil,nil,nil
    end

    --local player = game:PlayerLoginGame(oldPlayer)
    --result.TableID = player.TableID
    --result.ChairID = player.ChairID                 -- 把player桌子id，椅子id的数据 返回去
    local gameTable = game:GetTableByUID(player.TableID)
    if gameTable == nil then
        LuaNetWorkSendToUser(userId, MDM_GR_LOGON, SUB_GR_LOGON_FAILURE, nil, "没找到正确的桌子", nil)
        return nil,nil,nil
    end

    return player,game, gameTable
end


