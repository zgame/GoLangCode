---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by soonyo.zhengxh
--- DateTime: 2019/11/28 15:49
---

--------------------------------------------------------------------------------------
--- 玩家获取未读消息
--------------------------------------------------------------------------------------

--- 玩家获取未读消息
--- @param player   玩家对象
--- @param data     消息数据
function ChatTable:HandleUserGetUnReadMessage(player, data)
    -- 玩家判定
    if player == nil or player.ChatUser == nil then
        Logger("ChatTable:HandleUserGetUnReadMessage 玩家不存在")
        return
    end
    -- 解析消息
    local receiveMsg = CMD_GlobalServer_pb.CMD_C_GET_CHAT_MESSAGE()
    receiveMsg:ParseFromString(data)

    -- 好友ID
    local dwFriendID = receiveMsg.friend_user_id

    -- 消息响应
    local sendMsg = CMD_GlobalServer_pb.CMD_S_GET_CHAT_MESSAGE()
    sendMsg.friend_user_id = dwFriendID
    -- 好友关系判定
    if player:IsInFriendArray(dwFriendID) == 0 then
        LuaNetWorkSendToUser(player.User.UserID, MAIN_CHAT_SERVICE_CLIENT, SUB_S_GET_CHAT_MESSAGE, sendMsg)
        return
    end
    -- 获取该好友发来的未读消息的列表
    local tbFriendUnReadMessage = player:GetFriendUnReadMessage(dwFriendID)
    if tbFriendUnReadMessage then
        -- 消息ID
        local msgID = 0
        for i, v in ipairs(tbFriendUnReadMessage) do
            msgID = msgID + 1
            local msgInfo = sendMsg.msg_list:add()
            msgInfo.id          = msgID
            msgInfo.emotion     = tonumber(v[1])      -- 表情
            msgInfo.time_stamp  = tonumber(v[2])      -- 发送时间
            msgInfo.msg         = v[3]                -- 消息内容
        end
    end
    -- 清空该好友的未读消息
    player:DelFriendUnReadMessage(dwFriendID)

    LuaNetWorkSendToUser(player.User.UserID, MAIN_CHAT_SERVICE_CLIENT, SUB_S_GET_CHAT_MESSAGE, sendMsg)
end