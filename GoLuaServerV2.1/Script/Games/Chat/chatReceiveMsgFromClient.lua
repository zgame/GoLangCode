---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by soonyo.zhengxh
--- DateTime: 2019/11/28 15:26
---

--------------------------------------------------------------------------------------
--- 这里主要是聊天服接收玩家发来的消息
---（该逻辑在最终整合服务器时可以删除，处理玩家消息需迁移）
--------------------------------------------------------------------------------------

--- 接受玩家网络消息
--- @param serverId 游戏serverId
--- @param userId   玩家UserId
--- @param subMsgId 消息子协议
--- @param data     消息体
--- @param token    token验证
function ChatReceiveMsgFromClient(serverId, userId, subMsgId, data, token)
    -- 数据验证
    local game = GetGameByID(GameTypeChat)
    if game == nil then
        Logger("玩家消息聊天服服务game未找到")
        return
    end
    -- 找桌子（聊天只会创建一个桌子）
    local chatTable = game:GetTableByUID(game.TableUUID-1)
    if chatTable == nil then
        Logger("登录服消息聊天服服务chatTable未找到")
        return
    end
    -- 非登录须先找到玩家
    local player = GetPlayerByUID(userId)
    if subMsgId ~= SUB_C_LOGIN and player == nil then
        return
    end
    -- 消息派发
    if subMsgId == SUB_C_LOGIN then
        -- 玩家登录聊天服
        chatTable:HandleUserLogin(serverId, userId, data)
    elseif subMsgId == SUB_C_FRIEND_LIST then
        -- 玩家获取好友信息
        chatTable:HandleUserGetFriendList(player, data)
    elseif subMsgId == SUB_C_SEARCH_USER then
        -- 玩家搜索用户
        chatTable:HandleUserSearchPlayer(player, data)
    elseif subMsgId == SUB_C_APPLY_FRIEND then
        -- 玩家处理申请界面信息
        chatTable:HandleUserApplyFriend(player, data)
    elseif subMsgId == SUB_C_DELETE_FRIEND then
        -- 玩家删除好友
        chatTable:HandleUserDeleteFriend(player, data)
    elseif subMsgId == SUB_C_GET_CHAT_MESSAGE then
        -- 玩家获取未读消息
        chatTable:HandleUserGetUnReadMessage(player, data)
    elseif subMsgId == SUB_C_CHAT_MESSAGE then
        -- 玩家发送消息给好友
        chatTable:HandleUserSendMessage(player, data)
    elseif subMsgId == SUB_C_HEARTBEAT_CHAT then
        -- 心跳
        local receiveMsg = CMD_GlobalServer_pb.CMD_C_HEART_BEAT_CHAT()
        receiveMsg:ParseFromString(data)

        local sendMsg = CMD_GlobalServer_pb.CMD_S_HEART_BEAT_CHAT()
        sendMsg.time_stamp = os.time()
        LuaNetWorkSendToUser(userId, MAIN_CHAT_SERVICE_CLIENT, SUB_S_HEARTBEAT_CHAT, sendMsg, nil)
    end
end