---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by soonyo.zhengxh
--- DateTime: 2019/11/1 18:57
---

--------------------------------------------------------------------------------------
--- 主要处理玩家开火
--------------------------------------------------------------------------------------

--- 玩家开火消息处理
--- @param player 玩家
--- @param data   消息数据
function XhsTable:HandleOnUserFireToXHS(player,data)
    -- 玩家验证
    if player == nil then
        Logger("HandleOnUserFireToXHS plyaer 为nil")
        return
    end
    -- 解析消息
    local receiveMsg = CMD_XHS_Game_pb.CMD_C_XHS_USER_FIRE()
    receiveMsg:ParseFromString(data)

    -- 获取玩家User信息
    local user = player.User
    if user == nil then
        Logger("HandleOnUserFireToXHS user 为nil")
        return
    end
    local result = 0
    -- 验证玩家小海兽状态
    if user.SummonTimes == 0 or (user.SummonTimes > 0 and user.MonsterHP == 0) then
        result = 2 -- 已死亡
    end

    -- 验证玩家子弹数量
    if result == 0 and user.MonsterBulletNum == 0 then
        result = 1 -- 子弹数数量不足
    end

    if result > 0 then
        -- 验证失败的消息
        local sendResult = CMD_XHS_Game_pb.CMD_S_XHS_USER_FIRE()
        sendResult.result = result
        LuaNetWorkSendToUser(player.User.UserID, MDM_GF_GAME, SUB_S_DHS_USER_FIRE, sendResult,nil ,nil)
        return
    end

    -- 获取当前玩家海兽信息
    local excelXhsCritMin   = GetExcelXhsValue(user.MonsterID, "crit_min")
    local excelXhsCritMax   = GetExcelXhsValue(user.MonsterID, "crit_max")
    local excelXhsNormalMin = GetExcelXhsValue(user.MonsterID, "normal_min")
    local excelXhsNormalMax = GetExcelXhsValue(user.MonsterID, "normal_max")

    -- 获取击杀血量
    local hitDamage = 0
    if receiveMsg.is_crit > 0 then -- 是否出暴击范围
        hitDamage = GetRandom(excelXhsCritMin,excelXhsCritMax)
    else
        hitDamage = GetRandom(excelXhsNormalMin,excelXhsNormalMax)
    end

    -- 是否处在双倍buffer时间
    if player.XhsStartBuffTimes >0 and player.XhsIntervalBuffTimes > 0 then
        hitDamage = hitDamage * 2
    end

    -- 小海兽是否死亡
    if user.MonsterHP > hitDamage then
        -- 扣减血量
        user.MonsterHP = user.MonsterHP - hitDamage

        -- 处理是否增加双倍buffer
        if receiveMsg.is_crit > 0 and player.XhsStartBuffTimes == 0 and player.XhsIntervalBuffTimes == 0 then
            user.TotalCritNum = user.TotalCritNum + 1
            if (GetExcelXhsValue(user.MonsterID,"violent_num") > 0 and user.TotalCritNum % GetExcelXhsValue(user.MonsterID,"violent_num") == 0) then
                player.XhsStartBuffTimes    = os.time()
                player.XhsIntervalBuffTimes = GetExcelXhsValue(user.MonsterID,"violent_time")

                -- 发送玩家激活暴击状态
                local sendBuff = CMD_XHS_Game_pb.CMD_S_TRRIGETER_BUFF()
                sendBuff.time = player.XhsIntervalBuffTimes
                LuaNetWorkSendToUser(user.UserID, MDM_GF_GAME, SUB_S_BUFF_STATE_INFO, sendBuff, nil, nil)
            end
        end

        -- 返回掉血消息
        local sendResult = CMD_XHS_Game_pb.CMD_S_XHS_USER_FIRE()
        sendResult.result       = 0
        sendResult.monster_hp   = user.MonsterHP
        LuaNetWorkSendToUser(user.UserID, MDM_GF_GAME, SUB_S_DHS_USER_FIRE, sendResult, nil, nil)
    else
        -- 死亡
        -- 发奖励
        local awardGoldNum, awardItemID, awardItemNum, awardPuzzleID, awardPuzzleNum = 0, 0, 0, 0, 0
        local weightIndex = 0
        -- 金币
        local excelXhsDropGoldWeights = GetExcelXhsValue(user.MonsterID,"drop_gold_weights")
        if excelXhsDropGoldWeights and #excelXhsDropGoldWeights > 0 then
            weightIndex = TableWeightSelect(excelXhsDropGoldWeights)
            if weightIndex then
                local excelXhsDropGoldNum = GetExcelXhsValue(user.MonsterID,"drop_gold_num")
                if excelXhsDropGoldNum and #excelXhsDropGoldNum == #excelXhsDropGoldWeights then
                    awardGoldNum = excelXhsDropGoldNum[weightIndex]
                end
            end
        end

        -- 道具
        local excelXhsDropItemWeight = GetExcelXhsValue(user.MonsterID, "drop_item_weights")
        if excelXhsDropItemWeight and #excelXhsDropItemWeight > 0 then
            weightIndex     = TableWeightSelect(excelXhsDropItemWeight)
            if weightIndex then
                local excelXhsDropItemID = GetExcelXhsValue(user.MonsterID, "drop_item_id")
                local excelXhsDropItemNum = GetExcelXhsValue(user.MonsterID, "drop_item_num")
                if excelXhsDropItemID and excelXhsDropItemNum and #excelXhsDropItemID == #excelXhsDropItemNum
                        and weightIndex ~= 0 and weightIndex <= #excelXhsDropItemID then
                    awardItemID     = excelXhsDropItemID[weightIndex]
                    awardItemNum    = excelXhsDropItemNum[weightIndex]
                end
            end
        end

        -- 拼图碎片
        if GetExcelXhsValue(user.MonsterID,"drop_puzzle_probability") > GetRandom(1, 10000) then
            local excelXhsDropPuzzleWeight = GetExcelXhsValue(user.MonsterID,"drop_puzzle_weights")
            if excelXhsDropPuzzleWeight then
                weightIndex     = TableWeightSelect(excelXhsDropPuzzleWeight)
                if weightIndex ~= 0 then
                    local excelXhsDropPuzzleID = GetExcelXhsValue(user.MonsterID,"drop_puzzle_id")
                    local excelXhsDropPuzzleNum = GetExcelXhsValue(user.MonsterID,"drop_puzzle_num")
                    if excelXhsDropPuzzleID and excelXhsDropPuzzleNum and #excelXhsDropPuzzleID == #excelXhsDropPuzzleNum then
                        awardPuzzleID   = excelXhsDropPuzzleID[weightIndex]
                        awardPuzzleNum  = excelXhsDropPuzzleNum[weightIndex]
                    end
                end
            end
        end

        -- 记录游戏
        local strDst = string.format("%d:%d;%d:%d",awardItemID,awardItemNum,awardPuzzleID,awardPuzzleNum)
        SaveGameRecord(user.UserID,"击杀海兽", 0, awardGoldNum, 0,0, strDst)
        player:AddScore(awardGoldNum)                 -- 增加金币
        player:AddItem(awardItemID, awardItemNum)     -- 增加道具
        player:AddItem(awardPuzzleID, awardPuzzleNum) -- 增加碎片

        -- 返回击杀消息
        local sendResult = CMD_XHS_Game_pb.CMD_S_XHS_USER_FIRE()
        sendResult.result       = result
        sendResult.monster_hp   = 0
        sendResult.money        = awardGoldNum
        sendResult.item_id      = awardItemID
        sendResult.item_num     = awardItemNum
        sendResult.puzzle_id    = awardPuzzleID
        sendResult.puzzle_num   = awardPuzzleNum
        LuaNetWorkSendToUser(user.UserID, MDM_GF_GAME, SUB_S_DHS_USER_FIRE, sendResult, nil, nil)

        -- 清除玩家当前海兽信息
        user.MonsterID              = 0
        user.MonsterHP              = 0
        user.MonsterBulletNum       = 0
        user.TotalCritNum            = 0
        player.XhsStartBuffTimes    = 0
        player.XhsIntervalBuffTimes = 0
    end
    -- 保存海兽信息
    self:SaveSeaMonsterData(user,false)
end
