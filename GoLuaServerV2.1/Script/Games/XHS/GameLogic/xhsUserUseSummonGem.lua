---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by soonyo.zhengxh
--- DateTime: 2019/11/1 18:53
---

--------------------------------------------------------------------------------------
--- 主要处理玩家使用召唤石
--------------------------------------------------------------------------------------

--- 玩家使用召唤石
--- @param player 玩家
--- @param data   消息数据
function XhsTable:HandleOnUserUseSummonGem(player, data)
    -- 玩家验证
    if player == nil then
        Logger("HandleOnUserUseSummonGem plyaer 为nil")
        return
    end

    -- 解析消息
    local receiveMsg = CMD_XHS_Game_pb.CMD_S_USE_SUMMON_GEM()
    receiveMsg:ParseFromString(data)

    -- 道具验证
    local dwItemID = receiveMsg.item_id
    if dwItemID == 0 then
        Logger("HandleOnUserUseSummonGem ItemID 为0了")
        return
    end
    local itemMonsterID = GetExcelItemValue(dwItemID, "monster_id")
    if itemMonsterID == nil or itemMonsterID == 0 then
        Logger("HandleOnUserUseSummonGem 道具召唤ID错误")
        return
    end
    local itemType = GetExcelItemValue(dwItemID, "item_type")
    if itemType ~= Enum_ItemType.eItemType_Summon then
        Logger("HandleOnUserUseSummonGem 非召唤石道具")
        return
    end

    -- 小海兽验证
    local excelXhsBulletNum = GetExcelXhsValue(itemMonsterID, "bullet_num")
    if excelXhsBulletNum == nil then
        Logger("HandleOnUserUseSummonGem 获取小海兽子弹错误")
        return
    end
    local excelXhsHP = GetExcelXhsValue(itemMonsterID, "HP")
    if excelXhsHP == nil then
        Logger("HandleOnUserUseSummonGem 获取小海兽血量错误")
        return
    end

    -- 获取user对象信息
    local user = player.User
    if user == nil then
        Logger("HandleOnUserUseSummonGem user 为nil了")
        return
    end

    local result = 0
    -- 获取玩家道具验证
    local userItem = player:GetItemByItemID(dwItemID)
    if userItem == nil or userItem.Used >= userItem.Total then
        result = 3
    end
    -- 召唤时间验证
    if result == 0 and user.SummonTimes > 0 and user.MonsterHP == 0 then
        result = 1 -- 今天已经召唤并且击杀了
    end

    -- 当前剩余子弹验证
    if result == 0 and user.SummonTimes > 0 and user.MonsterBulletNum > 0 then
        result = 2 -- 今天已经召唤了并且剩余子弹还有(当前海兽还没有死亡)
    end

    if result > 0 then
        -- 召唤失败
        local sendResult = CMD_XHS_Game_pb.CMD_C_USE_SUMMON_GEM()
        sendResult.result       = result
        sendResult.bullet_num   = 0
        LuaNetWorkSendToUser(player.User.UserID, MDM_GF_GAME, SUB_S_USE_SUMMON_GEM, sendResult, nil, nil)
        return
    end
    --- 召唤成功
    -- 扣除道具
    userItem.Used = userItem.Used + 1
    -- 更改子弹数量
    user.MonsterBulletNum = excelXhsBulletNum

    -- 召唤新的海兽
    local bSummon = false
    if user.SummonTimes == 0 then
        -- 设置更改玩家身上相关属性
        user.MonsterID      = itemMonsterID
        user.MonsterHP      = excelXhsHP
        user.SummonTimes    = os.time()

        -- 同步海兽信息
        local sendMonster = CMD_XHS_Game_pb.tagSeaMonster()
        sendMonster.monster_id      = user.MonsterID
        sendMonster.monster_hp      = user.MonsterHP
        sendMonster.bullet_num      = 0
        sendMonster.monster_max_hp  = excelXhsHP
        sendMonster.summon_times    = user.SummonTimes
        local leftTime = GetIntervalBetweenNowAndTomorrow() - user.SummonTimes
        if leftTime > 0 then
            sendMonster.left_times = leftTime
        end
        LuaNetWorkSendToUser(player.User.UserID, MDM_GF_GAME, SUB_S_USER_DHS_INFO, sendMonster, nil, nil)

        -- 标记召唤成功
        bSummon = true

        -- 记录召唤日志
        SaveGameRecord(user.UserID,"[DHS]召唤海兽",0,0,0,0,"")
    end
    -- 保存召唤数据
    self:SaveSeaMonsterData(user,bSummon)
    -- 回复玩家消息
    local sendResult = CMD_XHS_Game_pb.CMD_C_USE_SUMMON_GEM()
    sendResult.item_id      = dwItemID
    sendResult.result       = result
    sendResult.bullet_num   = user.MonsterBulletNum
    LuaNetWorkSendToUser(player.User.UserID, MDM_GF_GAME, SUB_S_USE_SUMMON_GEM, sendResult, nil, nil)
end
